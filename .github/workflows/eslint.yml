# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json
name: "ESLint Analysis"
on:
  pull_request:
    paths:
      - "**/aura/**"
      - "**/lwc/**"
jobs:
  run-eslint:
    name: ESLint Run
    runs-on: ubuntu-latest
    env:
      FILE_LIST: files-to-lint.txt
      RESULT_FILE: results.sarif.json
    permissions:
      security-events: write
    steps:
      - uses: actions/checkout@v2
        with:
          ref: ${{ github.event.pull_request.head.sha }}
      - name: Run NPM install
        run: npm install
      - name: Collect Files to Lint
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: gh pr view ${{ github.event.number }} --json files --jq '.files | map(.path)[] | select(contains("/aura/") or contains("/lwc/"))' > $FILE_LIST
      - name: Run ESLint
        run: cat $FILE_LIST | xargs node_modules/.bin/eslint -o "$RESULT_FILE" -f @microsoft/eslint-formatter-sarif
      - uses: github/codeql-action/upload-sarif@v1
        if: always()
        with:
          sarif_file: ${{ env.RESULT_FILE }}
